<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Global Food Security Index</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        /* Use a fine grid background */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #fff;
            background-image:
                    linear-gradient(#ccc 1px, transparent 1px),
                    linear-gradient(90deg, #ccc 1px, transparent 1px);
            background-size: 20px 20px;
        }
        /* Chart container fills the viewport */
        #sunburst {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        .tooltip {
            position: absolute;
            padding: 8px;
            background: #4CAF50;
            color: white;
            border-radius: 5px;
            font-size: 14px;
            display: none;
            pointer-events: none;
            z-index: 9999;
        }
        .nav-button {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 10000;
        }
    </style>
</head>
<body>
    <div id="sunburst"></div>
    <div class="tooltip" id="tooltip"></div>
    <button class="nav-button" onclick="location.href='main.html'">Explore data on the map</button>
    <!-- Add country selection dropdown with a label -->
    <div style="position: absolute; left: 10px; top: 50px;">
        <p style="color: green; margin: 0 0 5px 0;">Select a country to highlight its data</p>
        <select id="countrySelect" onchange="highlightCountry()">
            <option value="">Select a Country</option>
        </select>
    </div>

<script>
    // ----- Add full-screen black overlay (covering the #sunburst container), showing title then fading out -----
    const overlay = d3.select("#sunburst")
        .append("div")
        .style("position", "absolute")
        .style("top", "0")
        .style("left", "0")
        .style("width", "100%")
        .style("height", "100%")
        .style("background", "black")
        .style("display", "flex")
        .style("justify-content", "center")
        .style("align-items", "center")
        .style("color", "white")
        .style("font-size", "48px")
        .style("z-index", "9999")
        .html("Global Food Security Index");

    overlay.transition()
        .delay(1000)
        .duration(2000)
        .style("opacity", 0)
        .on("end", () => overlay.remove());

    // ----- Draw the chart -----
    d3.csv("data/Global-Food-Security-Index2022.csv").then(data => {
        // 1. Sort data by Rank in ascending order
        data.sort((a, b) => +a.Rank - +b.Rank);

        // 2. Set fixed viewBox size: 1400×1000 (base dimensions)
        const baseWidth = 1400, baseHeight = 1000;

        // 3. Define the sizes for all circular charts (both main and small charts)
        const chartInnerRadius = 120;
        const chartOuterRadius = 250;  // Approximate circle diameter 500

        // 4. Main chart position (e.g., (700,700))
        const mainPos = { x: 700, y: 700 };

        // 5. Four small charts arranged along an arc using given angle array (in degrees) e.g., [185,245,298,355]
        //    and a fixed radius smallR to position them away from the main chart
        const smallR = 500;
        const smallAnglesDeg = [185, 245, 298, 355];
        const smallAngles = smallAnglesDeg.map(d => d * Math.PI / 180);

        // 6. Dimensions: main chart displays "Overall score", small charts display other dimensions
        const mainDimension = "Overall score";
        const smallDimensions = [
            "Affordability",
            "Availability",
            "Quality and Safety",
            "Sustainability and Adaptation"
        ];

        // 7. Create SVG (using viewBox to maintain proportions)
        d3.select("#sunburst").select("svg").remove();
        const svg = d3.select("#sunburst")
            .append("svg")
            .attr("viewBox", `0 0 ${baseWidth} ${baseHeight}`)
            .attr("preserveAspectRatio", "xMidYMid meet")
            .style("width", "100%")
            .style("height", "100%");

        // 8. Define color palette (green gradient based on Rank)
        const colorPalette = [
            "#274E13", "#1B5E20", "#2E7D32", "#388E3C", "#43A047",
            "#4CAF50", "#66BB6A", "#81C784", "#A5D6A7", "#C8E6C9"
        ];
        const colorScale = d3.scaleSequential()
            .domain([1, data.length])
            .interpolator(d3.interpolateRgbBasis(colorPalette));

        // 9. Define common angle scale: equally divide 0~2π among all countries
        const angleScale = d3.scaleBand()
            .domain(data.map(d => d.Country))
            .range([0, 2 * Math.PI])
            .padding(0.05);

        // 10. Define common length scale: lower Rank gives a longer bar
        const lengthScale = d3.scaleLinear()
            .domain([1, data.length])
            .range([chartInnerRadius + 20, chartOuterRadius]);

        // ----- Draw the main chart (Overall score) -----
        const mainGroup = svg.append("g")
            .attr("transform", `translate(${mainPos.x},${mainPos.y})`);

        const mainBars = mainGroup.selectAll("path")
            .data(data)
            .enter()
            .append("path")
            .attr("fill", d => colorScale(+d.Rank))
            .attr("stroke", "#fff")
            .attr("d", d => {
                const sA = angleScale(d.Country);
                const eA = sA + angleScale.bandwidth();
                // Initial state: inner and outer radii both set to chartInnerRadius (collapsed state)
                return d3.arc()
                    .innerRadius(chartInnerRadius)
                    .outerRadius(chartInnerRadius)
                    .startAngle(sA)
                    .endAngle(eA)();
            })
            .on("mouseover", function(event, d) {
                d3.select(this)
                    .transition().duration(300)
                    .attr("fill", "#FFD700")
                    .attr("d", () => {
                        const sA = angleScale(d.Country);
                        const eA = sA + angleScale.bandwidth();
                        return d3.arc()
                            .innerRadius(chartInnerRadius)
                            .outerRadius(lengthScale(+d[mainDimension]) + 10)
                            .startAngle(sA)
                            .endAngle(eA)();
                    });
                tooltip.style("display", "block")
                    .html(`<strong>${d.Country}</strong><br>Rank: ${d.Rank}<br>${mainDimension}: ${d[mainDimension]}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 20) + "px");
            })
            .on("mouseout", function(event, d) {
                d3.select(this)
                    .transition().duration(500)
                    .attr("fill", colorScale(+d.Rank))
                    .attr("d", () => {
                        const sA = angleScale(d.Country);
                        const eA = sA + angleScale.bandwidth();
                        return d3.arc()
                            .innerRadius(chartInnerRadius)
                            .outerRadius(lengthScale(+d[mainDimension]))
                            .startAngle(sA)
                            .endAngle(eA)();
                    });
                tooltip.style("display", "none");
            });

        // Animate the main chart expanding
        mainBars.transition().duration(2000)
            .attr("d", d => {
                const sA = angleScale(d.Country);
                const eA = sA + angleScale.bandwidth();
                return d3.arc()
                    .innerRadius(chartInnerRadius)
                    .outerRadius(lengthScale(+d[mainDimension]))
                    .startAngle(sA)
                    .endAngle(eA)();
            });

        // Add label under the main chart
        mainGroup.append("text")
            .attr("x", 0)
            .attr("y", chartOuterRadius + 30)
            .attr("text-anchor", "middle")
            .style("font-size", "18px")
            .style("fill", "#333")
            .text("Overall Score");

        // ----- Draw the four small charts arranged along an arc -----
        smallAngles.forEach((angle, i) => {
            // Calculate small chart center position relative to main chart
            const cx = mainPos.x + smallR * Math.cos(angle);
            const cy = mainPos.y + smallR * Math.sin(angle);
            const group = svg.append("g")
                .attr("transform", `translate(${cx},${cy})`);
            const currentDim = smallDimensions[i];

            const dimBars = group.selectAll("path")
                .data(data)
                .enter()
                .append("path")
                .attr("fill", d => colorScale(+d.Rank))
                .attr("stroke", "#fff")
                .attr("d", d => {
                    const sA = angleScale(d.Country);
                    const eA = sA + angleScale.bandwidth();
                    return d3.arc()
                        .innerRadius(chartInnerRadius)
                        .outerRadius(chartInnerRadius)
                        .startAngle(sA)
                        .endAngle(eA)();
                })
                .on("mouseover", function(event, d) {
                    d3.select(this)
                        .transition().duration(300)
                        .attr("fill", "#FFD700")
                        .attr("d", () => {
                            const sA = angleScale(d.Country);
                            const eA = sA + angleScale.bandwidth();
                            return d3.arc()
                                .innerRadius(chartInnerRadius)
                                .outerRadius(lengthScale(+d[currentDim]) + 10)
                                .startAngle(sA)
                                .endAngle(eA)();
                        });
                    tooltip.style("display", "block")
                        .html(`<strong>${d.Country}</strong><br>${currentDim}: ${d[currentDim]}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 20) + "px");
                })
                .on("mouseout", function(event, d) {
                    d3.select(this)
                        .transition().duration(500)
                        .attr("fill", colorScale(+d.Rank))
                        .attr("d", () => {
                            const sA = angleScale(d.Country);
                            const eA = sA + angleScale.bandwidth();
                            return d3.arc()
                                .innerRadius(chartInnerRadius)
                                .outerRadius(lengthScale(+d[currentDim]))
                                .startAngle(sA)
                                .endAngle(eA)();
                        });
                    tooltip.style("display", "none");
                });

            // Animate small charts expanding
            dimBars.transition().duration(2000)
                .attr("d", d => {
                    const sA = angleScale(d.Country);
                    const eA = sA + angleScale.bandwidth();
                    return d3.arc()
                        .innerRadius(chartInnerRadius)
                        .outerRadius(lengthScale(+d[currentDim]))
                        .startAngle(sA)
                        .endAngle(eA)();
                });

            // Add label under each small chart
            group.append("text")
                .attr("x", 0)
                .attr("y", chartOuterRadius + 30)
                .attr("text-anchor", "middle")
                .style("font-size", "18px")
                .style("fill", "#333")
                .text(currentDim);
        });

        // ----- Populate the country dropdown -----
        const countrySelect = document.getElementById("countrySelect");
            data.forEach(d => {
                const option = document.createElement("option");
                option.value = d.Country;
                option.textContent = d.Country;
                countrySelect.appendChild(option);
            });

            // Highlight the selected country
            window.highlightCountry = function() {
                const selectedCountry = countrySelect.value;

                mainBars.transition().duration(500)
                    .attr("fill", d => d.Country === selectedCountry ? "#FFD700" : colorScale(+d.Rank));

                // Also highlight the small charts
                svg.selectAll("g").each(function() {
                    const group = d3.select(this);
                    group.selectAll("path")
                        .transition().duration(500)
                        .attr("fill", d => d.Country === selectedCountry ? "#FFD700" : colorScale(+d.Rank));
                });
            };
        // ----- Add legend and academic annotation in the lower right -----
        const legendGroup = svg.append("g")
            .attr("transform", `translate(${baseWidth - 150}, ${baseHeight - 80})`);

        // First row: Legend title
        legendGroup.append("text")
            .attr("x", 200)
            .attr("y", 0)
            .attr("text-anchor", "start")
            .style("font-size", "14px")
            .style("fill", "#555")
            .text("Color Legend:");

        // Second row: Highest rank (deep green) indicator
        legendGroup.append("circle")
            .attr("cx", 200)
            .attr("cy", 20)
            .attr("r", 6)
            .style("fill", "#274E13"); // Deep green corresponds to Rank 1
        legendGroup.append("text")
            .attr("x", 215)
            .attr("y", 25)
            .attr("text-anchor", "start")
            .style("font-size", "14px")
            .style("fill", "#555")
            .text("Rank 1 (Highest)");

        // Third row: Lowest rank (light green) indicator
        legendGroup.append("circle")
            .attr("cx", 200)
            .attr("cy", 45)
            .attr("r", 6)
            .style("fill", "#C8E6C9"); // Light green corresponds to the lowest rank
        legendGroup.append("text")
            .attr("x", 215)
            .attr("y", 50)
            .attr("text-anchor", "start")
            .style("font-size", "14px")
            .style("fill", "#555")
            .text("Lowest Rank");

        // Fourth row: Data source and notes
        legendGroup.append("text")
            .attr("x", 200)
            .attr("y", 70)
            .attr("text-anchor", "start")
            .style("font-size", "14px")
            .style("fill", "#555")
            .text("Note: Data source: GFSI 2022.");

    });
</script>
</body>
</html>
